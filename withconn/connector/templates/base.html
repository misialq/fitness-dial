<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Withings Connector</title>

    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">

    {%  load static %}
    <link rel="stylesheet" href="{% static 'assets/css/material-dashboard.min.css' %}">
</head>
<body>

    <div class="sidebar" data-color="purple" data-background-color="white" data-image="{% static 'assets/img/sidebar-1.jpg' %}">
        <div class="logo">
            <a href="" class="simple-text logo-normal">WITHINGS CONNECTOR</a>
        </div>
        <div class="sidebar-wrapper">
            <form class="navbar-form">
                <span class="bmd-form-group"><div class="input-group no-border">
                <input type="text" value="" class="form-control" placeholder="Search...">
                <button type="submit" class="btn btn-white btn-round btn-just-icon">
                  <i class="material-icons">search</i>
                  <div class="ripple-container"></div>
                </button>
              </div></span>
            </form>
            <ul class="nav navbar-nav nav-mobile-menu">
              <li class="nav-item">
                <a class="nav-link" href="javascript:;">
                  <i class="material-icons">dashboard</i>
                  <p class="d-lg-none d-md-block">
                    Stats
                  </p>
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">notifications</i>
                  <span class="notification">5</span>
                  <p class="d-lg-none d-md-block">
                    Some Actions
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="#">Mike John responded to your email</a>
                  <a class="dropdown-item" href="#">You have 5 new tasks</a>
                  <a class="dropdown-item" href="#">You're now friend with Andrew</a>
                  <a class="dropdown-item" href="#">Another Notification</a>
                  <a class="dropdown-item" href="#">Another One</a>
                </div>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link" href="javascript:;" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">person</i>
                  <p class="d-lg-none d-md-block">
                    Account
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
                  <a class="dropdown-item" href="#">Profile</a>
                  <a class="dropdown-item" href="#">Settings</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="#">Log out</a>
                </div>
              </li>
            </ul>
            <ul class="nav">
              <li class="nav-item active  ">
                <a class="nav-link" href="./dashboard.html">
                  <i class="material-icons">dashboard</i>
                  <p>Last measurements</p>
                </a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="./weight.html">
                  <i class="material-icons">monitor_weight</i>
                  <p>Weight</p>
                </a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="./sleep.html">
                  <i class="material-icons">hotel</i>
                  <p>Sleep</p>
                </a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="./heart.html">
                  <i class="material-icons">favorite</i>
                  <p>Heart</p>
                </a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="./workouts.html">
                  <i class="material-icons">fitness_center</i>
                  <p>Workouts</p>
                </a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="./nutrition.html">
                  <i class="material-icons">fastfood</i>
                  <p>Nutrition</p>
                </a>
              </li>
            </ul>
        </div>
        <div class="sidebar-background" style="background-image: url({% static 'assets/img/sidebar-1.jpg' %}) ">
        </div>
    </div>

    <div class="main-panel">
        {%  block main-panel %}
      <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
            {% block navbar %}
        <div class="container-fluid">
          <div class="navbar-wrapper">
              {% block section-title %}{% endblock %}
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
            <span class="navbar-toggler-icon icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end">
            <ul class="navbar-nav">
                <li>
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                             Time range <i class="material-icons">query_builder</i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="#">3 days</a>
                        <a class="dropdown-item" href="#">7 days</a>
                        <a class="dropdown-item" href="#">14 days</a>
                        <a class="dropdown-item" href="#">1 month</a>
                        <a class="dropdown-item" href="#">3 months</a>
                        <a class="dropdown-item" href="#">6 months</a>
                        <a class="dropdown-item" href="#">9 months</a>
                    </div>
                </li>
              <li class="nav-item">
                <a class="nav-link" href="javascript:;">
                  <i class="material-icons">dashboard</i>
                  <p class="d-lg-none d-md-block">
                    Stats
                  </p>
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link" href="javascript:;" id="navbarDropdownProfile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="material-icons">person</i>
                  <p class="d-lg-none d-md-block">
                    Account
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownProfile">
                  <a class="dropdown-item" href="#">Profile</a>
                  <a class="dropdown-item" href="#">Settings</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="#">Log out</a>
                </div>
              </li>
            </ul>
          </div>
        </div>
        {% endblock %}
      </nav>

      <div class="content">
      {%  block content %}{% endblock %}
      </div>

      <footer class="footer">
        <div class="container-fluid">
          <div class="copyright float-right">
            Â©
            <script>
              document.write(new Date().getFullYear())
            </script>, made by <a href="https://github.com/misialq" target="_blank">@misialq</a>
          </div>
        </div>
      </footer>
        {% endblock %}
    </div>

    <!--   Core JS Files   -->
    <script src="{% static 'assets/js/core/jquery.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/js/core/popper.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/js/core/bootstrap-material-design.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/js/plugins/perfect-scrollbar.jquery.min.js' %}"></script>
    <!-- Plugin for the Perfect Scrollbar -->
    <script src="{% static 'assets/js/plugins/perfect-scrollbar.jquery.min.js' %}"></script>
    <!-- Chartist JS -->
    <script src="{% static 'assets/js/plugins/chartist.min.js' %}"></script>
    <!-- Notifications Plugin    -->
    <script src="{% static 'assets/js/plugins/bootstrap-notify.js' %}"></script>
    <!-- Control Center for Material Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="{% static 'assets/js/material-dashboard.js' %}" type="text/javascript"></script>
    <!-- Custom scripts -->
    <script>
        const dataHr = {{ last_sleep_raw.hr_series | safe }}
        const dataRr = {{ last_sleep_raw.rr_series | safe }}
        const tsHr = dataHr.map(x => new Date(x.timestamp).toTimeString().slice(0, 5))
        const tsRr = dataRr.map(x => new Date(x.timestamp).toTimeString().slice(0, 5))
        const hr = dataHr.map(x => x.value)
        const rr = dataRr.map(x => x.value)
        const avgHr = Math.round(hr.reduce((a,b) => a + b, 0) / hr.length);
        const avgRr = Math.round(rr.reduce((a,b) => a + b, 0) / rr.length);

        const sleepReportedAt = new Date({{ sleep_reported_at }});
        const sleepSummaryReportedAt = new Date({{ sleep_summary_reported_at }})
        const weightReportedAt = new Date({{ weight_reported_at }})

        function whenReported(date) {
            const today = new Date();
            const diffTime = Math.abs(today - date);

            const diffMinutes = Math.ceil(diffTime / (1000 * 60))
            if (diffMinutes < 1) {
                return "less than 1 minute ago"
            } else if (diffMinutes <= 15) {
                return `${diffMinutes} ago`
            } else {
                const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));
                if (diffHours < 1) {
                    return `less than 1 hour ago`
                } else if (diffHours <= 5) {
                    return `${diffHours} ago`
                } else {
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays < 1) {
                        return "less than 1 day ago"
                    } else if (diffDays <= 5) {
                        return `${diffDays} ago`
                    } else {
                        return "more than 5 days ago"
                    }
                }
            }
        }

        new Chartist.Line('#lastNightHeartRate',
            {
              labels: tsHr,
              series: [
                  hr
              ]},
            {
              low: 0,
              showArea: false
            });

        new Chartist.Line('#lastNightBreathingRate', {
              labels: tsRr,
              series: [
                  rr
              ]},
            {
              low: 0,
              showArea: false
            });

        document.getElementById("lastNightAvgHeartRate").innerHTML = `<i class="fa fa-long-arrow-up"></i> ${avgHr.toString()}`;
        document.getElementById("lastNightAvgBreathingRate").innerHTML = `<i class="fa fa-long-arrow-up"></i> ${avgRr.toString()}`;

        document.getElementById("hrReportTime").innerHTML = `<i class="material-icons">access_time</i> ${whenReported(sleepReportedAt)}`;
        document.getElementById("rrReportTime").innerHTML = `<i class="material-icons">access_time</i> ${whenReported(sleepReportedAt)}`;

        document.getElementById("weightReportTime").innerHTML = `<i class="material-icons">access_time</i> ${whenReported(weightReportedAt)}`;
        document.getElementById("fatReportTime").innerHTML = `<i class="material-icons">access_time</i> ${whenReported(weightReportedAt)}`;
        document.getElementById("pmvReportTime").innerHTML = `<i class="material-icons">access_time</i> ${whenReported(weightReportedAt)}`;
        document.getElementById("sleepScoreReportTime").innerHTML = `<i class="material-icons">access_time</i> ${whenReported(sleepSummaryReportedAt)}`;


        $(function() {
            $(".dropdown-menu a").click(function(){
              $(this).parents(".collapse").find('.btn').html(' ' + $(this).text() + ' <i class="material-icons">query_builder</i>');
              $(this).parents(".collapse").find('.btn').val($(this).data('value'));
            });

        });
    </script>

</body>
</html>